<head>

<html xmlns:th="http://www.thymeleaf.org"xmlns:sec="http://www.thymeleaf.org/extras/spring-security">


<link
  href="https://getbootstrap.com/docs/5.3/dist/css/bootstrap.min.css"
  rel="stylesheet"
  integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
  crossorigin="anonymous">
<script
  src="https://getbootstrap.com/docs/5.3/dist/js/bootstrap.bundle.min.js"
  integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
  crossorigin="anonymous"></script>
<link
  href="https://getbootstrap.com/docs/5.3/examples/sidebars/sidebars.css"
  rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/bxslider/4.2.15/jquery.bxslider.min.css" rel="stylesheet" />
<script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bxslider/4.2.15/jquery.bxslider.min.js"></script>
<link rel="stylesheet" href="css/style.css">

<!-- 부트스트랩 CSS 링크 -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap-datepicker@1.9.0/dist/js/bootstrap-datepicker.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/bootstrap-datepicker@1.9.0/dist/css/bootstrap-datepicker.min.css" rel="stylesheet">
<!-- Bootstrap Icons CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">

<title>기사 관리</title>

<!-- 그래프 -->
 <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    #datePickerButton {
        background-color: #3F7EFC;
        border-color: #3F7EFC; /* 선택적으로 테두리 색상을 지정할 수 있습니다. */
    }
    
    .circle {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    display: inline-block;
    margin-right: 5px;
  }

  .green { background-color: green; }
  .orange { background-color: orange; }
  .red { background-color: red; }
  
      body {
        margin: 0;
        padding: 0;
    }
    .background-image {
        position: fixed; /* 이미지를 고정된 위치에 배치 */
        top: 100px;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: -9999; /* 다른 요소들 보다 뒤로 */
        opacity: 0.4; /* 투명도 설정 */
    }
  
 #myChart {
    margin-left : 60px;
    margin-top : 20px;
    width: 1500px !important;
    height: 400px !important;
}

.bar {
        fill: #3F7EFC;
         opacity: 0; /* 초기에는 투명하게 설정 */
        }

        .bar-text {
            fill: white;
            font-size: 18px;
        }
        
        
      .chart-container{
        margin-top: -15px;
        border-top-left-radius : 15px ;
        border-top-right-radius: 15px ;
          
      }
       
         .data-table{
         
         border: 1px solid #4C4C4C; /* 표의 셀 테두리를 회색 실선으로 설정 */
         
         
       }  
       
        #tableContainer{
        margin-left: 80px;
         
     
        }
       
       #tableContainer th{
        font-size: 28px;
        color: white;
        width : 200px;
        height : 80px;
        text-align: center;
        background-color: #3F7EFC;
        border: 1px solid #4C4C4C; /* 표의 셀 테두리를 회색 실선으로 설정 */
        
        
        
       }
       
        #tableContainer tr{
        font-size: 25px;
      text-align: center;
        border: 1px solid #4C4C4C; /* 표의 셀 테두리를 회색 실선으로 설정 */
       }
       
        #tableContainer td{
       text-align: center;
        border: 1px solid #4C4C4C; /* 표의 셀 테두리를 회색 실선으로 설정 */
        /* border-radius: 30px; */
       }
</style>
 <th:block th:insert="~{fragments :: header}" style = "z-index : 9999"/>

</head>
<body>
    <!-- 템플릿 본문 내용 -->
 

    <main class="d-flex flex-nowrap" style= "z-index: 9999">
   <!--  <img class="background-image" src="images/adminBackground.PNG" alt="배경 이미지">  --> 
        <div class="d-flex flex-column align-items-stretch flex-shrink-0 bg-body-tertiary border border-r-1" style="width: 380px; margin-top: 10px;">
            <div class="d-flex align-items-center flex-shrink-0 p-3 link-body-emphasis text-decoration-none">
                <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="#4ae39c" viewBox="0 0 256 256" class="me-2">
                    <path d="M232,128A104,104,0,1,1,128,24,104.13,104.13,0,0,1,232,128Z" fill="#3F7EFC"></path>
                </svg>
                <span class="fs-5 fw-semibold">통계 현황</span>
                <button id="undoButton" class="btn btn-success"
                style="margin-left: 130px; top: 15px; right: 20px; z-index: 1030; background-color: #3F7EFC;">통계자료</button>
            </div>
            <div class="d-flex flex-wrap py-3 px-2 gap-3 align-items-center justify-content-center border-bottom">
                <div class="border-start border-2 h-50"></div>
                <div class="d-flex flex-column align-items-center">
                    <span class="fs-5 fw-semibold">지역 선택 : </span>
                </div>
                <div class="d-flex flex-column align-items-center">
                    <select id="local" name="local">
                        <option value="">선택하세요</option>
                        <option value="서구">서구</option>
                        <option value="동구">동구</option>
                        <option value="계양구">계양구</option>
                        <option value="부평구">부평구</option>
                        <option value="남동구">남동구</option>
                        <option value="미추홀구">미추홀구</option>
                        <option value="연수구">연수구</option>
                    </select>
                </div>
               
    
            
                <div class="d-flex flex-column align-items-center" >

    
                </div>
    
  
            </div>
            <div style="display: flex; justify-content: center; align-items: center; background-color: #3F7EFC;">
                <span class="fs-5 fw-semibold" style="margin-top: 5%; margin-bottom: 5%; color: #ffffff; ">PickUp Man List</span>
            </div>

            <!-- 드라이버 목록을 출력할 위치 -->
            <div class="list-group scrollarea px-3 flex-grow-1" >
                <div id="driverList" class="abc">
                    
                </div>
            </div>
            
            <!--  -->
        </div>
        <div style="width: 100%; height: 100%;"> 


     <div id="driverInfoList123" style="margin-left: 3%;">
        <!-- 여기에 운행 리스트가 나타날 것입니다. -->
    </div>
    
    <!--  현황 관련 div  -->
    <div id="totalGraph" style="margin-left: 90px;">
    
   <div style="display: flex; gap: 40px; "  >
  <!-- 접수 현황 -->
  <div style=  "width:720; height:350; margin-top: 3%; font-size: 16px; border: 5px solid gray; padding-right: 20px; border-radius: 15px; ">
      <h2 style=" margin-top:5%; margin-left: 80px;">3개월 총 접수 현황 : [[${TotalNodeCount} /2 ]] 건</h2>
    <svg id="graph" width="720" height="250" style= "margin-bottom: -3%; border-radius: 15px;" >

    </svg>
   <div id="graph-text" style="display: flex; margin-left:17%; margin-bottom:3%; width:720px"></div>

   <!-- 간격 조절 -->
  <div style="width: 350px;"></div>

   </div>
   <!-- 배차 현황 -->
   <div style=  "width:720; height:350; margin-top: 3%; font-size: 16px; border: 5px solid gray; padding-right: 20px; border-radius: 15px;">
     <h2 style=" margin-top:5%; margin-left: 80px;">3개월 총 배차 현황 : [[${TotalBechaCount}/2]] 건</h2>
    <svg id="graph1" width="720" height="250" style= "margin-bottom: -3%; " >
    </svg>
   <div id="graph-text1" style="display: flex; margin-left:17%; margin-bottom:3%;  width:720px;"></div>
</div>
   </div>
   
   
   
   
<div style="display: flex; gap: 40px;  margin-bottom : 2%;"  >

  <!-- 승인 현황 -->
  <div style=  "width:720; height:350; margin-top: 2%; font-size: 16px; border: 5px solid gray; padding-right: 20px; border-radius: 15px;">
      <h2 style=" margin-top:5%; margin-left: 80px;">3개월 총 승인 현황 : [[${totalDispatchListSize1}]] 건</h2>
    <svg id="graph2" width="720" height="250" style= "margin-bottom: -3%; border-radius: 15px;" >

    </svg>
   <div id="graph-text2" style="display: flex; margin-left:17%; margin-bottom:3%; width:720px"></div>

   <!-- 간격 조절 -->
  <div style="width: 350px;"></div>

   </div>
   <!-- 거절 현황 -->
   <div style=  "width:720; height:350; margin-top: 2%; font-size: 16px; border: 5px solid gray; padding-right: 20px; border-radius: 15px;">
     <h2 style=" margin-top:5%; margin-left: 80px;">3개월 총 거절 현황 : [[${totalDispatchListSize2}]] 건</h2>
    <svg id="graph3" width="720" height="250" style= "margin-bottom: -3%; " >
    </svg>
   <div id="graph-text3" style="display: flex; margin-left:17%; margin-bottom:3%;  width:720px;"></div>
</div>

   </div>
   </div>
     <div style="display: flex; align-items: flex-start; margin-top: 3%; margin-left: 3%; width: 100%; " id="driverInfomation" >
     <img  src='images/noimage.png'; style="width: 300px; height: auto;" id="driverImageDiv">
    <div style="margin-left: 3%;">
      
            <ul style="font-weight: bold; font-size: 27px;">
                <li id="driverName"> </li>
              
                 <br>
                <li id="driverPhone"></li>
                
                <br>
                <li id="driverLocal"></li>
              
                 <br>
                <li id="driverCarnum"></li>
       
                <li style="display:none;" id="driverId"></li>
            </ul>

    </div> 
    <div class="chart-container" >
    <div id="tableContainer"></div>
    </div>
</div>


<div class="chart-container">
         <canvas id="myChart" ></canvas>
    </div>
         
    </div>
         
    </main>    
</body>
<script th:inline="javascript" src="https://d3js.org/d3.v7.min.js"></script>
<script th:inline="javascript">
  
//"Undo" 버튼의 클릭 이벤트 핸들러를 설정하여 페이지를 새로고침
document.getElementById('undoButton').addEventListener('click', function() {
    location.reload();
});
  
    window.onload = function() {
    	
    	   var nList = /*[[${nList}]]*/ null;

           //redCircle 이미지 요소 가져오기
           var redCircle = document.getElementById('redCircle');

           // nList 값이 존재하면 redCircle 이미지 표시
           if (nList && nList.length > 0) {
               redCircle.style.display = 'inline'; // redCircle 이미지 표시
           } else {
               redCircle.style.display = 'none'; // redCircle 이미지 숨김
           }
    	
           
           
          $('#driverInfomation').hide();
          
           
           
           
        // 부트스트랩 달력 초기화
        $('#datePickerButton').datepicker({
            format: 'yyyy-mm-dd',
            autoclose: true,
            todayHighlight: true
        }).on('changeDate', function(e) {
            const selectedDate = formatDate(e.date); // formatDate 함수를 사용하여 날짜 형식 조정
            document.getElementById('DATE-TIME').innerText = selectedDate;
        });

        // 오늘 날짜 표시
        var today = new Date();
        var year = today.getFullYear();
        var month = (today.getMonth() + 1).toString().padStart(2, '0'); // 한 자릿수일 때 앞에 0을 붙임
        var day = today.getDate().toString().padStart(2, '0'); // 한 자릿수일 때 앞에 0을 붙임
        var dateString = year + '-' + month + '-' + day;
        document.getElementById('DATE-TIME').innerText = dateString;
        
        
       
       
        	 
        
    };
    
 // 주어진 날짜 객체를 yyyy-mm-dd 형식의 문자열로 변환하는 함수
    function formatDate(date) {
        const year = date.getFullYear();
        const month = (date.getMonth() + 1).toString().padStart(2, '0');
        const day = date.getDate().toString().padStart(2, '0');
        return `${year}-${month}-${day}`;
    }
    
    
    
  
    
        $(document).ready(function() {
            $('#local').change(function() {
                var selectedValue = $(this).val(); // 선택된 옵션의 값
                console.log("selectedValue =", selectedValue);
                // AJAX 요청
                $.ajax({
                    url: 'selectedLocal', // 컨트롤러의 URL
                    method: 'POST',
                    data: {
                        selectedValue: selectedValue
                    }, // 선택된 값 전송
                    success: function(response) {
                        // 성공적으로 서버로부터 응답을 받았을 때 수행할 작업
                        console.log('AJAX 요청이 성공적으로 전송되었습니다.');
                        console.log('응답 데이터:', response);
                        // 드라이버 목록 업데이트
                        updateDriverList(response);
                       
                    },
                    error: function(xhr, status, error) {
                        // Ajax 요청이 실패했을 때 수행할 작업
                        console.error('AJAX 요청이 실패하였습니다:', error);
                    }
                });
            });
        });
  
        // 드라이버 목록을 업데이트하는 함수
        function updateDriverList(driverData) {
            // 드라이버 목록을 초기화
            $('#driverList').empty();

            // 각 드라이버에 대한 정보를 출력
            driverData.forEach(function(driver) {
  	
                var driverItem = $('<a href="#" class="list-group-item list-group-item-action py-3 lh-sm mt-3 border rounded-2"></a>');
                driverItem.append('<img src="images/noimage.png" style="width: 300px; height: auto;" id="driverImage">')
                driverItem.append('<div class="d-flex w-100 align-items-center justify-content-start mb-1"></div>');
                driverItem.append('<div class="ma-1"></div>');
                driverItem.append('<div class="ma-2"></div>');
                driverItem.find('.d-flex').append('<span type="text"> 이름 : '+ driver.m_NAME +'</span>');
                driverItem.find('.d-flex').append('<input type="hidden" id="dr_ID" value="'+driver.dr_ID+'">');
                driverItem.find('.d-flex').append('<input type="hidden" id="m_ID" value="'+driver.m_ID+'">');
                console.log("driver.dr_ID = ", driver.dr_ID);
                driverItem.find('.ma-1').append('<span type="text"> 운행구역 : '+ driver.dr_AREA +'</span>');
                driverItem.find('.ma-2').append('<span type="text"> 차량번호 : '+ driver.dr_CARNUM +'</span>');
                
                // 링크를 클릭했을 때 이벤트 처리
                // 클릭 이벤트 핸들러를 설정하는 코드
                $('#driverList').append(driverItem);
                
                var memberID = $('#m_ID').val();
                
                $.ajax({
                    url: 'GetDriverImage', // 컨트롤러의 URL
                    method: 'POST',
                    data: {
                        M_ID : memberID
                    }, // 선택된 값 전송
                    success: function(response) {
                        // 성공적으로 서버로부터 응답을 받았을 때 수행할 작업
                      
                      
                    console.log("GetDriverImage  = "+response);
                        
                       if (response) {
                           // 서버에서 이미지가 반환되었을 때
                           $('#driverImage').attr('src', '/upload/' + response);
                           $('#driverImageDiv').attr('src', '/upload/' + response);
                       } else {
                           // 서버에서 이미지가 null이거나 비어있을 때
                           $('#driverImage').attr('src', 'images/noimage.png');
                           $('#driverImageDiv').attr('src', '/upload/' + response);
                       }
                        
                    },
                    error: function(xhr, status, error) {
                        // Ajax 요청이 실패했을 때 수행할 작업
                        console.error('AJAX 요청이 실패하였습니다:', error);
                       
                    }
                });
                
            });
            
        let myChart;
    $(document).on('click', '#driverList a', function(event) {
        event.preventDefault(); // 기본 동작 방지
        var memberID = parseInt($(this).find('#m_ID').val());
        // image 불러오기
        $.ajax({
            url: 'GetDriverImage', // 컨트롤러의 URL
            method: 'POST',
            data: {
                M_ID : memberID
            }, // 선택된 값 전송
            success: function(response) {
                // 성공적으로 서버로부터 응답을 받았을 때 수행할 작업
              
              
            console.log("GetDriverImage  = "+response);
                
               if (response) {
                   // 서버에서 이미지가 반환되었을 때
                   $('#driverImage').attr('src', '/upload/' + response);
                   $('#driverImageDiv').attr('src', '/upload/' + response);
               } else {
                   // 서버에서 이미지가 null이거나 비어있을 때
                   $('#driverImage').attr('src', 'images/noimage.png');
                   $('#driverImageDiv').attr('src', '/upload/' + response);
               }
                
            },
            error: function(xhr, status, error) {
                // Ajax 요청이 실패했을 때 수행할 작업
                console.error('AJAX 요청이 실패하였습니다:', error);
               
            }
        });
        
        var driverID = parseInt($(this).find('#dr_ID').val()); // 드라이버 ID 가져오기
        console.log("Clicked driver ID:", driverID);
        	        if(myChart) {
	        	        myChart.destroy();        	        	
        	        }
        	        
        	        const canvas = document.getElementById('myChart');
                    const context = canvas.getContext('2d');
                    context.clearRect(0, 0, canvas.width, canvas.height);
                const tableContainer = document.getElementById('tableContainer');
                tableContainer.innerHTML = '';
        
        // 선택된 드라이버의 정보를 가져와서 화면에 출력
        var selectedDriver = driverData.find(function(driver) {
            return parseInt(driver.dr_ID) === parseInt(driverID);
        });
        if (selectedDriver) {
            displayDriverInfo(selectedDriver);
        	
        	    
        	 // 표를 리셋
        	    
            $.ajax({
                url: 'adminDRMTproc', // 컨트롤러의 URL
                method: 'POST',
                data: {
                    DR_ID: driverID
                }, // 선택된 값 전송
                success: function(response) {
                    // 성공적으로 서버로부터 응답을 받았을 때 수행할 작업
                    console.log('AJAX 요청이 성공적으로 전송되었습니다.');
                    console.log('응답 데이터:', response);
                    // 드라이버 목록 업데이트
                 
                    // 출근 시간 데이터 생성
                 const  arrivalData = generateArrivalData(response) || Array(7).fill(0);
                    console.log("arrivalData =" + arrivalData );
                    // 퇴근 시간 데이터 생성
                 const  departureData = generateDepartureData(response) || Array(7).fill(0);
                    console.log("departureData =" + departureData );
                    
                    
                    // 날짜 라벨 생성
                    const currentDate = new Date();
                    const labels = [];
                    for (let i = 6; i >= 0; i--) { // 7일 이전부터 역순으로 데이터를 가져옴
                        const date = new Date(currentDate);
                        date.setDate(date.getDate() - i); // i일 전의 날짜로 설정
                        labels.push(`${date.getMonth() + 1}/${date.getDate()}`);
                    }


                    const chartData = {
                        labels: labels,
                        datasets: [
                            {
                                label: '출근 시간',
                                data: arrivalData,
                                borderColor: 'rgb(75, 192, 192)',
                                tension: 0.1
                            },
                            {
                                label: '퇴근 시간',
                                data: departureData,
                                borderColor: 'rgb(255, 159, 64)',
                                tension: 0.1
                            }
                        ]
                    };

                    const options = {
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: '시간',
                                    fontSize: 16,
                                    fontWeight: 'bold'
                                },
                                min: 6,
                                max: 20,
                                stepSize: 1,
                                ticks: {
                                    fontSize: 14,
                                    fontWeight: 'bold',
                                      
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: '날짜',
                                    fontSize: 16,
                                    fontWeight: 'bold'
                                },
                                ticks: {
                                    fontSize: 14,
                                    fontWeight: 'bold',
                                      
                                }
                            }
                        }
                    };

                    // 캔버스 요소 가져오기
                    const canvas = document.getElementById('myChart');

                    // 캔버스 컨텍스트 가져오기
                    const ctx = canvas.getContext('2d');

                    // 선 그래프 생성
                     myChart = new Chart(ctx, {
                        type: 'line',
                        data: chartData,
                        options: {
                            ...options,
                            plugins: {
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            const datasetLabel = context.dataset.label || '';
                                            const time = context.parsed.y.toFixed(2);
                                            return `${datasetLabel}: ${time}시`;
                                        }
                                    }
                                }
                            }
                        }
                    });
                    
                 // 표를 생성할 div 요소 가져오기
                    const tableContainer = document.getElementById('tableContainer');

                    // 표 생성
                    const table = document.createElement('table');
                    table.classList.add('data-table');

                    // 표 헤더 생성
                    const thead = document.createElement('thead');
                    const headerRow = document.createElement('tr');
                    const headers = ['번 호', '날 짜', '출 근 시 간', '퇴 근 시 간'];

                    headers.forEach(headerText => {
                        const th = document.createElement('th');
                        th.textContent = headerText;
                        headerRow.appendChild(th);
                    });
                    thead.appendChild(headerRow);

                    // 표 바디 생성
                    const tbody = document.createElement('tbody');
                    chartData.labels.forEach((date, index) => {
                      const formattedArrivalTime = formatTime(arrivalData[index]);
                      const formattedEndTime = formatTime(departureData[index]);
                      
                      // 시간이 "00:00"인 경우 빈 문자열로 설정
                        const arrivalTimeDisplay = formattedArrivalTime === "NaN:NaN" || formattedArrivalTime === "00:00" ? "" : formattedArrivalTime;
                        const endTimeDisplay = formattedEndTime === "NaN:NaN" || formattedEndTime === "00:00" ? "" : formattedEndTime;
                      
                        const rowData = [index + 1, date, arrivalTimeDisplay, endTimeDisplay];
                        const row = document.createElement('tr');
                        rowData.forEach(cellData => {
                            const cell = document.createElement('td');
                            cell.textContent = cellData;
                            row.appendChild(cell);
                        });
                        tbody.appendChild(row);
                      
                    });

                    // 표에 헤더와 바디 추가
                    table.appendChild(thead);
                    table.appendChild(tbody);

                    // 표를 페이지에 추가
                    tableContainer.appendChild(table);
                    
                    
                    
                },
                error: function(xhr, status, error) {
                    // Ajax 요청이 실패했을 때 수행할 작업
                    console.error('AJAX 요청이 실패하였습니다:', error);
                }
            });
            
            
        
        	
        }else {
            console.error('error');
        }
     // 드라이버 정보를 화면에 출력하는 함수
        function displayDriverInfo(driverInfo) {
    	 
        	 $('#driverInfomation').show();
    	 
    	 
            $('#driverName').text('이름 : ' + driverInfo.m_NAME);
            $('#driverPhone').text('전화번호 : ' + driverInfo.m_PHONE);
          
            $('#driverLocal').text('주 운행지 : ' + driverInfo.dr_AREA);
            $('#driverCarnum').text('차량 번호 : ' + driverInfo.dr_CARNUM);
            $('#driverId').text(driverInfo.dr_ID);
            
        
        }
        document.getElementById('totalGraph').style.display = 'none';
        
     //2024-04-29 진행중-------------------------------------------------------------------------
    
    var driverID = parseInt($(this).find('#dr_ID').val());
//     var GetDriverList = [[${GetDriverList}]];




    

   // 출근 시간 데이터 생성
      function generateArrivalData(response) {
          const currentDate = new Date();
          const arrivalData = [];

          // 오늘 날짜 기준으로 -6일까지의 출근 시간 데이터 생성
          for (let i = 6; i >= 0; i--) {
              const date = new Date(currentDate);
              date.setDate(date.getDate() - i); // i일 전의 날짜로 설정
              
              const dataOfDay = response.find(data => {
                  const dataDate = new Date(data.dm_STWORK.split(' ')[0]);
                  return dataDate.toDateString() === date.toDateString(); // 해당 일자의 데이터가 있는지 확인
              });
              
              if (dataOfDay) {
                  const dm_STWORK = dataOfDay.dm_STWORK;
                  if(dm_STWORK !== null){
                  const [datepart, timepart] = dm_STWORK.split(' ');
                  const [hours, minutes] = timepart.split(':').map(Number);
                  const time = hours + minutes / 60;
                  arrivalData.push(time);
                  }else{
                	  console.log('출근 시간: 데이터 없음');
                  }
              } else {
                  arrivalData.push(null); // 데이터가 없는 경우 null 추가
              }
          }

          return arrivalData;
      }

   // 퇴근 시간 데이터 생성
      function generateDepartureData(response) {
          const currentDate = new Date();
          const departureData = [];

          // 오늘 날짜 기준으로 -6일까지의 퇴근 시간 데이터 생성
          for (let i = 6; i >= 0; i--) {
              const date = new Date(currentDate);
              date.setDate(date.getDate() - i); // i일 전의 날짜로 설정
              
              const dataOfDay = response.find(data => {
                  const dataDate = new Date(data.dm_STWORK.split(' ')[0]);
                  return dataDate.toDateString() === date.toDateString(); // 해당 일자의 데이터가 있는지 확인
              });

              if (dataOfDay) {
                  const dm_ENDWORK = dataOfDay.dm_ENDWORK;
                  if(dm_ENDWORK !== null){
                  const [datepart, timepart] = dm_ENDWORK.split(' ');
                  const [hours, minutes] = timepart.split(':').map(Number);
                  const time = hours + minutes / 60;
                  departureData.push(time);
                  }else{
                	  console.log("데이터 없음.");
                  }
              } else {
                  departureData.push(null); // 데이터가 없는 경우 null 추가
              }
          }

          return departureData;
      }



   
    
     
    });
    
    
 }
        
 // *----------------------------------현황 관련 스크립트------------------------------------------------------------------------------*
     // 데이터 예시 (21개, 37개, 22개)
        var nodeListsize = [[${nodeListsize}]];
       var pmnsize = [[${previousMonthNodeListsize}]];
       var tmansize = [[${twoMonthsAgoNodeListsize}]]; 
       var current = [[${currentDateStr}]];
       var previous = [[${previousMonth}]];
       var two = [[${twoMonthsAgo}]];
     
       
       
      
       
       const data = [tmansize, pmnsize, nodeListsize];
       const months = [two, previous, current];
       



       document.addEventListener("DOMContentLoaded", function() {
           var total = tmansize+pmnsize+nodeListsize;
           const svg = d3.select("#graph"),
               margin = { top: 20, right: 20, bottom: 30, left: 40 },
               width = +svg.attr("width") - margin.left - margin.right,
               height = +svg.attr("height") - margin.top - margin.bottom;

           const x = d3.scaleBand()
               .range([0, width])
               .padding(0.1);
           const y = d3.scaleLinear()
               .range([height, 0]);

           const g = svg.append("g")
               .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

           x.domain(data.map((d, i) => i + 1));
           y.domain([0, 100]); // 최대값을 100으로 설정

           // 막대 애니메이션 효과 추가
           g.selectAll(".bar")
               .data(data)
               .enter().append("rect")
               .attr("class", "bar")
               .attr("x", (d, i) => x(i + 1))
               .attr("y", height) // 초기 위치를 아래로 설정
               .attr("width", x.bandwidth())
               .transition()
               .duration(1000) // 애니메이션 지속 시간 (밀리초)
               .delay((d, i) => i * 100) // 각 막대마다 약간의 지연을 줌
               .attr("y", d => height - (d / total * 100) * height / 100) // 비율에 따라 높이 조정
               .attr("height", d => (d / total) * 100 * height / 100)
               .style("opacity", 1); // 애니메이션이 끝나면 막대를 불투명하게 설정

            // 텍스트 추가
               g.selectAll(".bar-text")
                   .data(data)
                   .enter().append("text")
                   .attr("class", "bar-text")
                   .attr("x", (d, i) => x(i + 1) + x.bandwidth() / 2)
                   .attr("y", d => height - (d / total * 100) * height / 100 + 20) // 막대 위로부터 14px 아래로 조정
                   .attr("text-anchor", "middle")
                   .text((d,i) => {
                       if (i === 0) return tmansize/2 + '건';
                        if (i === 1) return pmnsize/2 + '건';
                        if (i === 2) return nodeListsize/2 + '건';
                   })
                   .style("opacity", 0) // 초기에 투명하게 설정
                   .transition()
                   .duration(1000) // 애니메이션 지속 시간 (밀리초)
                   .delay((d, i) => i * 100) // 각 텍스트에 약간의 지연을 줌
                   .style("opacity", 1); // 애니메이션이 끝나면 투명도를 1로 설정
                   
                   
               // 그래프 아래에 추가적인 텍스트 추가
               d3.select("#graph-text")
              .selectAll("div")
           .data(months)
           .enter().append("div")
           .style("margin-right", "22.5%") // 왼쪽 정렬 추가
           .style("font-size", "16px") // 글자 크기 조정
           .style("font-weight", "bold") // 글자 굵기 조정

                   .text(d => d);
                           
               });
     
       var dispathNow = [[${dispathNowListsize}]];
       var dispathPrev = [[${dispathPrevListsize}]];
       var dispathTwo = [[${dispathTwoListsize}]];
       
      
       
       const data1 = [dispathTwo, dispathPrev, dispathNow];
       const months1 = [two, previous, current];
       
       
       document.addEventListener("DOMContentLoaded", function() {
          var total = dispathTwo+ dispathPrev+ dispathNow;
           const svg = d3.select("#graph1"),
               margin = { top: 20, right: 20, bottom: 30, left: 40 },
               width = +svg.attr("width") - margin.left - margin.right,
               height = +svg.attr("height") - margin.top - margin.bottom;

           const x = d3.scaleBand()
               .range([0, width])
               .padding(0.1);
           const y = d3.scaleLinear()
               .range([height, 0]);

           const g = svg.append("g")
               .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

           x.domain(data.map((d, i) => i + 1));
           y.domain([0, 100]); // 최대값을 100으로 설정

           // 막대 애니메이션 효과 추가
           g.selectAll(".bar")
               .data(data1)
               .enter().append("rect")
               .attr("class", "bar")
               .attr("x", (d, i) => x(i + 1))
               .attr("y", height) // 초기 위치를 아래로 설정
               .attr("width", x.bandwidth())
               .transition()
               .duration(1000) // 애니메이션 지속 시간 (밀리초)
               .delay((d, i) => i * 100) // 각 막대마다 약간의 지연을 줌
               .attr("y", d => height - (d / total * 100) * height / 100) // 비율에 따라 높이 조정
               .attr("height", d => (d / total) * 100 * height / 100)
               .style("opacity", 1); // 애니메이션이 끝나면 막대를 불투명하게 설정

            // 텍스트 추가
               g.selectAll(".bar-text1")
                   .data(data1)
                   .enter().append("text")
                   .attr("class", "bar-text")
                   .attr("x", (d, i) => x(i + 1) + x.bandwidth() / 2)
                   .attr("y", d => height - (d / total * 100) * height / 100 + 20) // 막대 위로부터 14px 아래로 조정
                   .attr("text-anchor", "middle")
                    .text((d,i) => {
                      if (i === 0) return dispathTwo/2 + '건';
                        if (i === 1) return dispathPrev/2 + '건';
                        if (i === 2) return dispathNow/2 + '건';
                   })

                   .style("opacity", 0) // 초기에 투명하게 설정
                   .transition()
                   .duration(1000) // 애니메이션 지속 시간 (밀리초)
                   .delay((d, i) => i * 100) // 각 텍스트에 약간의 지연을 줌
                   .style("opacity", 1); // 애니메이션이 끝나면 투명도를 1로 설정
                   
               // 그래프 아래에 추가적인 텍스트 추가
               d3.select("#graph-text1")
              .selectAll("div")
           .data(months1)
           .enter().append("div")
             .style("margin-right", "22.5%") // 왼쪽 정렬 추가
   .style("font-size", "16px") // 글자 크기 조정
   .style("font-weight", "bold") // 글자 굵기 조정

           .text(d => d);
                   
       });
       
       var Now2 = [[${dispatchNowListSize1}]];
       var Prev2 = [[${dispatchPrevListSize1}]];
       var Two2 = [[${dispatchTwoListSize1}]];
       
      
       
       const data2 = [Two2, Prev2, Now2];
       const months2 = [two, previous, current];
       
       
       document.addEventListener("DOMContentLoaded", function() {
          var total = Two2 + Prev2 + Now2
           const svg = d3.select("#graph2"),
               margin = { top: 20, right: 20, bottom: 30, left: 40 },
               width = +svg.attr("width") - margin.left - margin.right,
               height = +svg.attr("height") - margin.top - margin.bottom;

           const x = d3.scaleBand()
               .range([0, width])
               .padding(0.1);
           const y = d3.scaleLinear()
               .range([height, 0]);

           const g = svg.append("g")
               .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

           x.domain(data.map((d, i) => i + 1));
           y.domain([0, 100]); // 최대값을 100으로 설정

           // 막대 애니메이션 효과 추가
           g.selectAll(".bar")
               .data(data2)
               .enter().append("rect")
               .attr("class", "bar")
               .attr("x", (d, i) => x(i + 1))
               .attr("y", height) // 초기 위치를 아래로 설정
               .attr("width", x.bandwidth())
               .transition()
               .duration(1000) // 애니메이션 지속 시간 (밀리초)
               .delay((d, i) => i * 100) // 각 막대마다 약간의 지연을 줌
               .attr("y", d => height - (d / total * 100) * height / 100) // 비율에 따라 높이 조정
               .attr("height", d => (d / total) * 100 * height / 100)
               .style("opacity", 1); // 애니메이션이 끝나면 막대를 불투명하게 설정

            // 텍스트 추가
               g.selectAll(".bar-text2")
                   .data(data2)
                   .enter().append("text")
                   .attr("class", "bar-text")
                   .attr("x", (d, i) => x(i + 1) + x.bandwidth() / 2)
                   .attr("y", d => height - (d / total * 100) * height / 100 + 20) // 막대 위로부터 14px 아래로 조정
                   .attr("text-anchor", "middle")
                    .text((d,i) => {
                      if (i === 0) return Two2 + '건';
                        if (i === 1) return Prev2 + '건';
                        if (i === 2) return Now2 + '건';
                   })

                   .style("opacity", 0) // 초기에 투명하게 설정
                   .transition()
                   .duration(1000) // 애니메이션 지속 시간 (밀리초)
                   .delay((d, i) => i * 100) // 각 텍스트에 약간의 지연을 줌
                   .style("opacity", 1); // 애니메이션이 끝나면 투명도를 1로 설정
                   
               // 그래프 아래에 추가적인 텍스트 추가
               d3.select("#graph-text2")
              .selectAll("div")
           .data(months1)
           .enter().append("div")
             .style("margin-right", "22.5%") // 왼쪽 정렬 추가
   .style("font-size", "16px") // 글자 크기 조정
   .style("font-weight", "bold") // 글자 굵기 조정

           .text(d => d);
                   
       });
       
       var Now3 = [[${dispatchNowListSize2}]];
       var Prev3 = [[${dispatchPrevListSize2}]];
       var Two3 = [[${dispatchTwoListSize2}]];
       
      
       
       const data3 = [Two3, Prev3, Now3];
       const months3 = [two, previous, current];
       
       
       document.addEventListener("DOMContentLoaded", function() {
            var total = Two3 +  Prev3 +  Now3;
           const svg = d3.select("#graph3"),
               margin = { top: 20, right: 20, bottom: 30, left: 40 },
               width = +svg.attr("width") - margin.left - margin.right,
               height = +svg.attr("height") - margin.top - margin.bottom;

           const x = d3.scaleBand()
               .range([0, width])
               .padding(0.1);
           const y = d3.scaleLinear()
               .range([height, 0]);

           const g = svg.append("g")
               .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

           x.domain(data.map((d, i) => i + 1));
           y.domain([0, 100]); // 최대값을 100으로 설정

           // 막대 애니메이션 효과 추가
           g.selectAll(".bar")
               .data(data3)
               .enter().append("rect")
               .attr("class", "bar")
               .attr("x", (d, i) => x(i + 1))
               .attr("y", height) // 초기 위치를 아래로 설정
               .attr("width", x.bandwidth())
               .transition()
               .duration(1000) // 애니메이션 지속 시간 (밀리초)
               .delay((d, i) => i * 100) // 각 막대마다 약간의 지연을 줌
               .attr("y", d => height - (d / total * 100) * height / 100) // 비율에 따라 높이 조정
               .attr("height", d => (d / total) * 100 * height / 100)
               .style("opacity", 1); // 애니메이션이 끝나면 막대를 불투명하게 설정

            // 텍스트 추가
               g.selectAll(".bar-text3")
                   .data(data3)
                   .enter().append("text")
                   .attr("class", "bar-text")
                   .attr("x", (d, i) => x(i + 1) + x.bandwidth() / 2)
                   .attr("y", d => height - (d / total * 100) * height / 100 + 20) // 막대 위로부터 14px 아래로 조정
                   .attr("text-anchor", "middle")
                    .text((d,i) => {
                      if (i === 0) return Two3 + '건';
                        if (i === 1) return Prev3 + '건';
                        if (i === 2) return Now3 + '건';
                   })

                   .style("opacity", 0) // 초기에 투명하게 설정
                   .transition()
                   .duration(1000) // 애니메이션 지속 시간 (밀리초)
                   .delay((d, i) => i * 100) // 각 텍스트에 약간의 지연을 줌
                   .style("opacity", 1); // 애니메이션이 끝나면 투명도를 1로 설정
                   
               // 그래프 아래에 추가적인 텍스트 추가
               d3.select("#graph-text3")
              .selectAll("div")
           .data(months1)
           .enter().append("div")
             .style("margin-right", "22.5%") // 왼쪽 정렬 추가
   .style("font-size", "16px") // 글자 크기 조정
   .style("font-weight", "bold") // 글자 굵기 조정

           .text(d => d);
                   
       });
    // arrivalData[index]를 시, 분, 초 형식으로 변환하는 함수
       function formatTime(timeDecimal) {
           const hours = Math.floor(timeDecimal); // 시간 부분 추출
           const minutesDecimal = (timeDecimal - hours) * 60; // 분으로 변환
           const minutes = Math.floor(minutesDecimal); // 분 부분 추출
          

           // 시, 분, 초가 한 자리 숫자인 경우 앞에 0을 추가하여 두 자리로 만듭니다.
           const formattedHours = hours < 10 ? '0' + hours : hours;
           const formattedMinutes = minutes < 10 ? '0' + minutes : minutes;
          

           // 시, 분, 초를 형식에 맞춰 조합하여 반환합니다.
           return formattedHours + ':' + formattedMinutes ;
       }
        
    // arrivalData[index]를 시, 분, 초 형식으로 변환하는 함수
       function formatTime1(timeDecimal1) {
           const hours = Math.floor(timeDecimal1); // 시간 부분 추출
           const minutesDecimal = (timeDecimal1 - hours) * 60; // 분으로 변환
           const minutes = Math.floor(minutesDecimal); // 분 부분 추출
          

           // 시, 분, 초가 한 자리 숫자인 경우 앞에 0을 추가하여 두 자리로 만듭니다.
           const formattedHours = hours < 10 ? '0' + hours : hours;
           const formattedMinutes = minutes < 10 ? '0' + minutes : minutes;
          

           // 시, 분, 초를 형식에 맞춰 조합하여 반환합니다.
           return formattedHours + ':' + formattedMinutes ;
       }
  
    </script> 
   
    
  

</html>