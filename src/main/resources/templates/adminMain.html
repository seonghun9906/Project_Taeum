<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<link
  href="https://getbootstrap.com/docs/5.3/dist/css/bootstrap.min.css"
  rel="stylesheet"
  integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
  crossorigin="anonymous">
<script
  src="https://getbootstrap.com/docs/5.3/dist/js/bootstrap.bundle.min.js"
  integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
  crossorigin="anonymous"></script>
<link
  href="https://getbootstrap.com/docs/5.3/examples/sidebars/sidebars.css"
  rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/bxslider/4.2.15/jquery.bxslider.min.css" rel="stylesheet" />
<script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bxslider/4.2.15/jquery.bxslider.min.js"></script>
<link rel="stylesheet" href="css/style.css">
<!-- 부트스트랩 CSS 링크 -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap-datepicker@1.9.0/dist/js/bootstrap-datepicker.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/bootstrap-datepicker@1.9.0/dist/css/bootstrap-datepicker.min.css" rel="stylesheet">
<!-- Bootstrap Icons CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
<title>관리자 메인</title>

<head>
<meta charset="UTF-8">
   

    <link rel="stylesheet" href="css/style.css">
     <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=9c49835d1348562532a0d8a13f2f7bf3&libraries=clusterer"></script>
    <th:block th:insert="~{fragments :: header}" />
</head>
<body>
    <!-- 템플릿 본문 내용 -->
   <main class="d-flex flex-nowrap">
  <div class="d-flex flex-column align-items-stretch flex-shrink-0 bg-body-tertiary border border-r-1" style="width: 380px;">
    <div class="d-flex align-items-center flex-shrink-0 p-3 link-body-emphasis text-decoration-none">
      <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="#4ae39c" viewBox="0 0 256 256" class="me-2">
        <path d="M232,128A104,104,0,1,1,128,24,104.13,104.13,0,0,1,232,128Z" fill="#3F7EFC"></path>
      </svg>
      <span class="fs-5 fw-semibold">접 수 현 황</span>
      
    </div>
      <div
      class="d-flex flex-wrap py-3 px-2 gap-3 align-items-center justify-content-center border-bottom">
    <div class="border-start border-2 h-50"></div>
      <div class="d-flex flex-column align-items-center">
        <div id="DATE-TIME"> </div>
        <div class="fw-light" style="font-size: 0.8rem">DATE
        <button type="button" class="btn btn-secondary p-0" id="datePickerButton" >
        <i class="bi bi-calendar"></i>
        </button>
        </div>
      </div>
      <div class="border-start border-2 h-50"></div>
      <div class="d-flex flex-column align-items-center">
        <div id="Count">0</div>
        <div class="fw-light" style="font-size: 0.8rem">접 수 현 황</div>
      </div>
      <div class="border-start border-2 h-50"></div>
        </div>
        <div style="display: flex; justify-content: center; align-items: center; background-color: #3F7EFC;">
        <span class="fs-5 fw-semibold" style="margin-top: 5%; margin-bottom: 5%; color: #ffffff;" >M  E  N  U</span>
        </div>
        <!--  <a href="driverAutoJoin" class="list-group-item list-group-item-action py-3 lh-sm mt-3 border rounded-2" style="background-color: #f0f8ff;">
        <div class="d-flex w-100 align-items-center justify-content-start mb-1" style="margin-top: 8%; ">
          <span class="badge text-bg-secondary" style=" margin-bottom: 6%; margin-right:25%;">등록</span><strong class="ms-1" style="margin-bottom: 6%;">기 사 등 록</strong>
      
        </div>
      </a> -->
        <a href="adminDriverList" class="list-group-item list-group-item-action py-3 lh-sm mt-3 border rounded-2" style="background-color: #f0f8ff;">
        <div class="d-flex w-100 align-items-center justify-content-start mb-1" style="margin-top: 8%">
          <span class="badge text-bg-secondary" style=" margin-bottom: 6%;  margin-right:25%;">배정</span><strong class="ms-1" style=" margin-bottom: 6%;">기 사 배 정</strong>
    
        </div>
      </a>
      
         <a href="adminDRMT" class="list-group-item list-group-item-action py-3 lh-sm mt-3 border rounded-2" style="background-color: #f0f8ff;">
        <div class="d-flex w-100 align-items-center justify-content-start mb-1" style="margin-top: 8%">
          <span class="badge text-bg-secondary" style=" margin-bottom: 6%; margin-right:25%;">관리</span><strong class="ms-1" style=" margin-bottom: 6%;">기 사 통 계</strong>
      
        </div>
      </a>
      
      
      <a href="board" class="list-group-item list-group-item-action py-3 lh-sm mt-3 border rounded-2" style="background-color: #f0f8ff;">
        <div class="d-flex w-100 align-items-center justify-content-start mb-1" style="margin-top: 8%">
          <span class="badge text-bg-secondary" style=" margin-bottom: 6%; margin-right:25%;">문의</span><strong class="ms-1" style=" margin-bottom: 6%;">문 의 내 역</strong>
    
        </div>
      </a>
    </div>
    
    
    
    <div id="map" style="width:100%;height:100%; z-index: 0;"></div>
</main>
    
<script th:inline="javascript">

var map = new kakao.maps.Map(document.getElementById('map'), {
    center: new kakao.maps.LatLng(37.4845117, 126.694807), // 지도의 중심좌표 
    level: 8 // 지도의 확대 레벨 
});

// 마커를 담을 배열
var markers = [];



//nodeList를 사용하여 마커와 클러스터러를 추가합니다.
var nodeList = /*[[${nodeList}]]*/ null;
//console.log("nodeList = ", nodeList);

 window.onload = function() {
var nList = /*[[${nList}]]*/ null;

//redCircle 이미지 요소 가져오기
var redCircle = document.getElementById('redCircle');

// nList 값이 존재하면 redCircle 이미지 표시
if (nList && nList.length > 0) {
    redCircle.style.display = 'inline'; // redCircle 이미지 표시
} else {
    redCircle.style.display = 'none'; // redCircle 이미지 숨김
}
 };

// 노드 리스트를 반복하면서 각 노드에 대해 마커를 생성하고 markers 배열에 추가합니다.
for (const node of nodeList) {
   // console.log(node);
    addMarker(node);
}

// 클러스터러를 생성합니다.
var clusterer = new kakao.maps.MarkerClusterer({
    map: map, // 지도 객체
    averageCenter: false, // 클러스터 마커의 중심 위치를 평균화할지 여부
    minLevel: 8 // 클러스터러가 동작할 최소 지도 레벨
});

// 클러스터러에 마커들을 추가합니다.
clusterer.addMarkers(markers);

// 해당하는 노드의 마커를 추가하는 함수
function addMarker(node) {
    var markerPosition = new kakao.maps.LatLng(node.y, node.x); // 해당하는 노드의 위치
    var marker = new kakao.maps.Marker({
        position: markerPosition
    });
    markers.push(marker);
    updateCount();// 마커를 markers 배열에 추가합니다.
}

//#Count 업데이트 함수
function updateCount() {
    var count = nodeList.length; // nodeList의 길이가 접수 현황의 개수입니다.
  //  console.log(nodeList.length);
    document.getElementById('Count').innerText = count; // #Count 업데이트
}




$(document).ready(function() {
	   // DATE-TIME 요소에서 현재 날짜 표시
    var currentDate = new Date();
    var year = currentDate.getFullYear();
    var month = ('0' + (currentDate.getMonth() + 1)).slice(-2);
    var day = ('0' + currentDate.getDate()).slice(-2);
    var dateString = year + '-' + month + '-' + day;
    $('#DATE-TIME').text(dateString);

    // 부트스트랩 달력 초기화
    $('#datePickerButton').datepicker({
        format: 'yyyy-mm-dd',
        autoclose: true,
        todayHighlight: true
    }).on('changeDate', function(e) {
        // 선택한 날짜를 DATE-TIME에 표시
        var selectedDate = e.format();
        console.log("selectedDate = " + selectedDate);
        $('#DATE-TIME').text(selectedDate);
        
        // AJAX 요청
        $.ajax({
            url: 'selectLocaldate', // 컨트롤러의 URL
            method: 'POST',
            data: { date: selectedDate }, // 선택된 날짜를 데이터로 전송
            success: function(response) {
                // 성공적으로 서버로부터 응답을 받았을 때 수행할 작업
         
                console.log("selectLocaldate = " , response);
                nodeList = response;
                updateMarkers();
                updateCount(); // #Count 업데이트
                
            },
            error: function(xhr, status, error) {
                // Ajax 요청이 실패했을 때 수행할 작업
                alert('Ajax 요청이 실패하였습니다: ' + error);
            }
        });
        
    });


//마커를 업데이트하는 함수
function updateMarkers() {
    // 이전 마커를 모두 제거합니다.
    for (var i = 0; i < markers.length; i++) {
        markers[i].setMap(null);
    }
    
    // 새로운 마커를 추가합니다.
    markers = [];
    for (const node of nodeList) {
        addMarker(node);
    }
    
    // 클러스터러를 다시 설정합니다.
    clusterer.clear();
    clusterer.addMarkers(markers);
}
});

$(function() {
    const msg = /*[[${msg}]]*/null;
    if (msg != null) {
      alert(msg);
    }
  });

</script>
</body>
</html>